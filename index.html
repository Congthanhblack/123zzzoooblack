<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>T·ª≠u V∆∞∆°ng V11 - Logic C√¢n B·∫±ng</title>
    <style>
        :root {
            --gold: #ffcc00; --bg: #0d0d10; --card: #1a1a20; --text: #eee;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg); color: var(--text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; padding: 0;
            height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* 1. HEADER G·ªåN */
        header {
            flex: 0 0 auto;
            padding: 8px 15px; background: #16161c;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #333;
        }
        header h1 { font-size: 0.9rem; margin: 0; color: var(--gold); letter-spacing: 1px; }
        .fund-box { font-weight: bold; color: #2ed573; font-size: 1.1rem; }

        /* 2. KHU V·ª∞C V√íNG QUAY - ƒê√É H·∫† TH·∫§P XU·ªêNG 2 D√íNG (PADDING-TOP) */
        .stage {
            flex: 1 1 auto;
            display: flex; justify-content: center; 
            align-items: flex-start; 
            padding-top: 50px; /* H·∫° th·∫•p xu·ªëng kho·∫£ng 2 d√≤ng */
            gap: 12px;
            position: relative;
        }
        .wheel-wrap {
            position: relative;
            width: 46vw; max-width: 36vh; 
            aspect-ratio: 1/1;
        }
        canvas {
            width: 100%; height: 100%; border-radius: 50%;
            border: 3px solid #2a2a32;
            transition: transform 4s cubic-bezier(0.1, 0, 0.1, 1);
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .pointer {
            position: absolute; top: -12px; left: 50%; transform: translateX(-50%);
            width: 24px; height: 30px; background: #fff;
            clip-path: polygon(50% 100%, 0 0, 100% 0); z-index: 10;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }
        .tag {
            position: absolute; bottom: -22px; width: 100%;
            text-align: center; font-size: 0.75rem; color: #666; font-weight: bold;
        }

        /* 3. ƒêI·ªÄU KHI·ªÇN */
        .controls {
            flex: 0 0 auto;
            background: var(--card);
            padding: 15px;
            border-radius: 20px 20px 0 0;
            display: flex; flex-direction: column; gap: 10px;
        }

        #intro-txt { text-align: center; font-size: 0.85rem; color: #888; min-height: 1.2rem; }
        
        #result-box {
            text-align: center; min-height: 50px;
            display: flex; flex-direction: column; justify-content: center;
            border-top: 1px solid #333; padding-top: 5px;
        }
        .res-main { font-weight: 800; font-size: 1.2rem; color: var(--gold); }
        .res-joke { font-size: 0.8rem; color: #aaa; font-style: italic; }

        .btn-main {
            background: linear-gradient(135deg, #f1c40f, #e67e22);
            border: none; padding: 15px; border-radius: 12px;
            color: #000; font-weight: 900; font-size: 1.1rem;
            width: 100%; box-shadow: 0 4px 0 #9e6d00;
            text-transform: uppercase;
        }
        .btn-main:active { transform: translateY(2px); box-shadow: 0 2px 0 #9e6d00; }
        .btn-main:disabled { filter: grayscale(1); opacity: 0.5; }

        .btn-row { display: flex; gap: 10px; }
        .btn-sub {
            flex: 1; background: #2d2d36; border: 1px solid #444; color: #bbb;
            padding: 10px; border-radius: 8px; font-size: 0.85rem; font-weight: bold;
        }

        .modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            z-index: 100; align-items: center; justify-content: center;
        }
        .modal-content {
            background: var(--card); padding: 25px; border-radius: 15px;
            width: 85%; max-width: 320px; border: 1px solid var(--gold);
        }
    </style>
</head>
<body>

    <header>
        <h1>V11 - LOGIC C√ÇN B·∫∞NG</h1>
        <div class="fund-box">QU·ª∏: <span id="fund">200</span>K</div>
    </header>

    <div class="stage">
        <div class="wheel-wrap">
            <div class="pointer"></div>
            <canvas id="cvName"></canvas>
            <div class="tag">B·∫¢N Lƒ®NH</div>
        </div>
        <div class="wheel-wrap">
            <div class="pointer"></div>
            <canvas id="cvGift"></canvas>
            <div class="tag">S·ªê PH·∫¨N</div>
        </div>
    </div>

    <div class="controls">
        <div id="intro-txt">"Nh√¢n ph·∫©m t·ªët, r∆∞·ª£u s·∫Ω b·ªõt n·ªìng..."</div>
        
        <div id="result-box">
            <div class="res-main" id="resText">B·∫Øt ƒë·∫ßu ti·ªác!</div>
            <div class="res-joke" id="resJoke"></div>
        </div>

        <button class="btn-main" id="spinBtn">üî• QUAY NGAY üî•</button>
        
        <div class="btn-row">
            <button class="btn-sub" onclick="toggleMenu()">üìä B·∫£ng ƒëi·ªÉm</button>
            <button class="btn-sub" onclick="undo()">‚è™ Ho√†n t√°c</button>
        </div>
    </div>

    <div id="menuModal" class="modal">
        <div class="modal-content">
            <h3 style="text-align:center; color:var(--gold); margin-top:0">C√ÄI ƒê·∫∂T</h3>
            <div id="rankings" style="max-height:180px; overflow-y:auto; margin-bottom:15px; font-size:0.9rem"></div>
            <button class="btn-sub" style="width:100%; margin-bottom:10px; color:var(--gold)" onclick="editPlayers()">üë• Th√™m/ƒê·ªïi ng∆∞·ªùi ch∆°i</button>
            <button class="btn-sub" style="width:100%; margin-bottom:10px" onclick="editFund()">üí∞ S·ª≠a ti·ªÅn qu·ªπ</button>
            <button class="btn-main" style="width:100%; font-size:0.9rem" onclick="toggleMenu()">ƒê√ìNG</button>
        </div>
    </div>

<script>
    // --- D·ªÆ LI·ªÜU ---
    let names = ["NCT", "A Qu·∫£", "C. Lan", "A Thi", "E Chinh", "E H√≤a", "S∆°n", "Thao"];
    const gifts = [
        { label: "1 Ch√©n", color: "#e74c3c", val: 1, fund: 0, weight: 8 },
        { label: "2 Ch√©n", color: "#c0392b", val: 2, fund: 0, weight: 4 },
        { label: "50% Ly", color: "#e67e22", val: 0.5, fund: 0, weight: 6 },
        { label: "Ch·ªâ ƒë·ªãnh", color: "#9b59b6", val: 0, fund: 0, weight: 3 },
        { label: "G√≥p 20k", color: "#f1c40f", val: 0, fund: 20, weight: 2 },
        { label: "L√¨ x√¨ 20k", color: "#2ecc71", val: 0, fund: -20, weight: 1.5 },
        { label: "Qua l∆∞·ª£t", color: "#3498db", val: 0, fund: 0, weight: 2 }
    ];

    const drinkJokes = [
        "R∆∞·ª£u b·∫•t kh·∫£ √©p, nh∆∞ng √©p th√¨ ph·∫£i u·ªëng!",
        "T·ª≠u l∆∞·ª£ng do tr·ªùi, ch√©n n√†y do b·∫°n.",
        "ƒê·ª´ng nh√¨n v√≤ng quay, h√£y nh√¨n v√†o ƒë√°y ly!",
        "B·∫£n lƒ©nh n·∫±m ·ªü ch√©n n√†y, c·ªë l√™n!",
        "M·ªôt ch√©n n√†y, t√¨nh c·∫£m ƒëi l√™n!"
    ];

    let fund = 200, drinkStats = {}, nameBag = [], giftBag = [], rotN = 0, rotG = 0, lastLog = null;

    // --- THU·∫¨T TO√ÅN T√öI & C√ÇN B·∫∞NG X√ÅC SU·∫§T ---
    function initBag() {
        // T√™n: M·ªói ng∆∞·ªùi ch∆°i ƒë·ªÅu c√≥ ƒë√∫ng 2 phi·∫øu trong t√∫i b·∫•t k·ªÉ s·ªë l∆∞·ª£ng bao nhi√™u
        nameBag = [];
        names.forEach(n => {
            nameBag.push(n);
            nameBag.push(n);
        });
        nameBag.sort(() => Math.random() - 0.5);

        // Qu√†: D·ª±a tr√™n tr·ªçng s·ªë (Weight)
        giftBag = [];
        gifts.forEach(g => {
            for(let i=0; i<g.weight; i++) giftBag.push(g);
        });
        giftBag.sort(() => Math.random() - 0.5);
    }

    // --- GAME LOGIC ---
    function spin() {
        const btn = document.getElementById('spinBtn');
        if(btn.disabled) return;
        btn.disabled = true;

        // N·∫øu t√∫i r·ªóng, t·ª± ƒë·ªông l√†m m·ªõi ƒë·ªÉ ƒë·∫£m b·∫£o chu k·ª≥ m·ªõi
        if(!nameBag.length || !giftBag.length) initBag();
        
        const targetName = nameBag.pop();
        const targetGift = giftBag.pop();

        const nIdx = names.indexOf(targetName);
        const gIdx = gifts.findIndex(g => g.label === targetGift.label);
        const nSlice = 360/names.length;
        const gSlice = 360/gifts.length;

        // Quay √≠t nh·∫•t 5 v√≤ng + g√≥c d·ª´ng chu·∫©n x√°c
        rotN = (rotN - (rotN%360)) + 1800 + (270 - (nIdx*nSlice) - nSlice/2);
        rotG = (rotG - (rotG%360)) + 1800 + (270 - (gIdx*gSlice) - gSlice/2);

        document.getElementById('cvName').style.transform = `rotate(${rotN}deg)`;
        document.getElementById('cvGift').style.transform = `rotate(${rotG}deg)`;
        document.getElementById('intro-txt').innerText = "üåÄ V·∫≠n m·ªánh ƒëang xoay v·∫ßn...";

        setTimeout(() => {
            if(targetGift.val > 0) drinkStats[targetName] += targetGift.val;
            fund += targetGift.fund; if(fund < 0) fund = 0;
            
            lastLog = { name: targetName, gift: targetGift };
            
            let joke = "";
            if(targetGift.val > 0) joke = drinkJokes[Math.floor(Math.random()*drinkJokes.length)];
            else if(targetGift.fund > 0) joke = "Ti·ªÅn l√† ph√π du, n·ªôp qu·ªπ l√† nghƒ©a v·ª•!";
            else if(targetGift.fund < 0) joke = "Qu·ªπ ƒëang m·ªâm c∆∞·ªùi v·ªõi b·∫°n! L√¨ x√¨ trao tay.";
            else joke = "Th·∫ßn may m·∫Øn ƒë√£ ƒë·ªô b·∫°n!";

            document.getElementById('resText').innerHTML = `${targetName} ‚ûî <span style="color:${targetGift.color}">${targetGift.label}</span>`;
            document.getElementById('resJoke').innerText = `"${joke}"`;
            
            updateUI();
            btn.disabled = false;
        }, 4100);
    }

    // --- V·∫º & C·∫¨P NH·∫¨T (X·ª¨ L√ù T·ª∞ ƒê·ªòNG KHI TH√äM T√äN) ---
    function draw(id, items) {
        const cv = document.getElementById(id);
        const ctx = cv.getContext('2d');
        const count = items.length;
        const arc = 2*Math.PI/count;
        cv.width = 600; cv.height = 600;

        items.forEach((it, i) => {
            const ang = i*arc;
            ctx.beginPath(); ctx.moveTo(300, 300); ctx.arc(300,300,295, ang, ang+arc);
            // M√†u s·∫Øc xen k·∫Ω cho t√™n
            ctx.fillStyle = (typeof it === 'string') ? (i%2?'#1c1c24':'#252530') : it.color;
            ctx.fill(); ctx.strokeStyle = "#444"; ctx.lineWidth = 1; ctx.stroke();
            
            ctx.save(); ctx.translate(300, 300); ctx.rotate(ang + arc/2);
            ctx.textAlign="right"; ctx.fillStyle="#fff"; 
            // T·ª± ƒë·ªông ch·ªânh c·ª° ch·ªØ n·∫øu t√™n qu√° nhi·ªÅu
            const fontSize = count > 10 ? 24 : 32;
            ctx.font=`bold ${fontSize}px Arial`;
            
            let txt = (typeof it === 'string') ? it : it.label;
            if(txt.includes("L√¨ x√¨")) txt = "+" + txt.split(" ")[2];
            if(txt.includes("G√≥p")) txt = "-20k";
            
            ctx.fillText(txt, 270, 10); ctx.restore();
        });
    }

    function updateUI() {
        document.getElementById('fund').innerText = fund;
        let html = "";
        Object.entries(drinkStats).sort((a,b)=>b[1]-a[1]).forEach(([n,v],i) => {
            html += `<div style="display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid #333">
                <span>${i+1}. ${n}</span> <span style="color:var(--gold);font-weight:bold">${v} ch√©n</span>
            </div>`;
        });
        document.getElementById('rankings').innerHTML = html || "Ch∆∞a ai u·ªëng...";
    }

    function editPlayers() {
        let v = prompt("Th√™m/S·ª≠a t√™n c√°c chi·∫øn h·ªØu (c√°ch nhau d·∫•u ph·∫©y):", names.join(", "));
        if(v) {
            names = v.split(",").map(x=>x.trim()).filter(x=>x);
            // Kh·ªüi t·∫°o ƒëi·ªÉm cho ng∆∞·ªùi m·ªõi m√† kh√¥ng l√†m m·∫•t ƒëi·ªÉm ng∆∞·ªùi c≈©
            names.forEach(n => { if(drinkStats[n] === undefined) drinkStats[n] = 0; });
            initBag(); // Quan tr·ªçng: Reset t√∫i ƒë·ªÉ chia l·∫°i x√°c su·∫•t c√¢n b·∫±ng
            draw('cvName', names);
            updateUI();
        }
    }

    function editFund() {
        let v = prompt("Nh·∫≠p s·ªë ti·ªÅn qu·ªπ hi·ªán t·∫°i (k):", fund);
        if(v && !isNaN(v)) { fund = parseInt(v); updateUI(); }
    }

    function undo() {
        if(!lastLog) return alert("Kh√¥ng c√≥ g√¨ ƒë·ªÉ ho√†n t√°c!");
        if(confirm(`H·ªßy k·∫øt qu·∫£ c·ªßa ${lastLog.name}?`)) {
            if(lastLog.gift.val > 0) drinkStats[lastLog.name] -= lastLog.gift.val;
            fund -= lastLog.gift.fund;
            nameBag.push(lastLog.name); giftBag.push(lastLog.gift); 
            lastLog = null; updateUI();
            document.getElementById('resText').innerText = "ƒê√£ ho√†n t√°c!";
            document.getElementById('resJoke').innerText = "";
        }
    }

    function toggleMenu() { 
        const m = document.getElementById('menuModal');
        m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
    }

    window.onload = () => {
        names.forEach(n => drinkStats[n] = 0);
        initBag();
        draw('cvName', names);
        draw('cvGift', gifts);
        updateUI();
        document.getElementById('spinBtn').onclick = spin;
    };
</script>
</body>
</html>
